name: Terraform CI/CD
on:
  push:
    branches:
      - main
    # paths: 
    #   - eks-infra/**
    #   - eks-vault/**
  pull_request:
    branches:
      - main
    # paths: 
    #   - eks-infra/**
    #   - eks-vault/**
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  BUCKET_TF_STATE: ${{ secrets.BUCKET_TF_STATE }}
  EKS_TF_PATH: eks-infra
  TF_VERSION: 1.13.3
permissions:
  contents: read
  security-events: write

jobs:
  terraform-plan-check:
    name: Terraform Check & Plan
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - name: "EKS Infrastructure"
            path: "eks-infra"
          - name: "Vault Configuration"
            path: "eks-vault"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4.3.1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: ./.github/actions/setup-terraform
        with:
          terraform-version: ${{ env.TF_VERSION }}
          working-directory: ${{ matrix.service.path }}
  
      - name: Terraform Init (remote S3)
        run: |
          terraform init \
            -backend-config="bucket=${{ env.BUCKET_TF_STATE }}" \
            -backend-config="key=${{ matrix.service.path }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -input=false
        working-directory: ${{ matrix.service.path }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check
        working-directory: ${{ matrix.service.path }}

      - name: Terraform Validate
        id: validate
        run: terraform validate
        working-directory: ${{ matrix.service.path }}

      - name: Check S3 state for eks-infra
        id: check_s3
        run: |
          if aws s3api head-object --bucket "${{ env.BUCKET_TF_STATE }}" --key "eks-infra/terraform.tfstate" >/dev/null 2>&1; then
            echo "state_exists=true" >> $GITHUB_OUTPUT
          else
            echo "state_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Plan
        id: plan
        if: ${{ steps.fmt.outcome == 'success' && steps.validate.outcome == 'success' && (matrix.service.path != 'eks-vault' || steps.check_s3.outputs.state_exists == 'true') }}
        run: terraform plan -no-color -input=false -out planfile
        working-directory: ${{ matrix.service.path }}

      - name: Log plan skipped
        if: ${{ steps.plan.outcome == 'skipped' }}
        run: echo "Terraform plan skipped for ${{ matrix.service.name }} (missing inputs or previous step failed)"
        working-directory: ${{ matrix.service.path }}

      - name: Save Plan Output
        if: ${{ steps.plan.outcome == 'success' }}
        run: |
          if [ -f planfile ]; then
            terraform show -no-color planfile > plan.txt
          else
            echo "planfile missing" >&2
            exit 1
          fi
        working-directory: ${{ matrix.service.path }}

      - name: Upload Plan as Artifact
        if: ${{ steps.plan.outcome == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ matrix.service.name }}
          path: |
            ${{ matrix.service.path }}/plan.txt
            ${{ matrix.service.path }}/planfile
          retention-days: 14

  security-scan:
    name: IaC Security Scan
    runs-on: ubuntu-latest
    needs: terraform-plan-check
    strategy:
      matrix:
        service:
          - name: "EKS Infrastructure"
            path: "eks-infra"
          - name: "Vault Configuration"
            path: "eks-vault"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Setup Terraform
        uses: ./.github/actions/setup-terraform
        with:
          terraform-version: ${{ env.TF_VERSION }}
          working-directory: ${{ matrix.service.path }}

      - name: Terraform Init (local)
        run: terraform init -backend=false
        working-directory: ${{ matrix.service.path }}

      - name: Run Checkov (IaC Security)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: ${{ matrix.service.path }}
          output_format: sarif
          output_file_path: ${{ github.workspace }}/${{ matrix.service.path }}/checkov-results.sarif
          soft_fail: true
      
      - run: |
          echo "Listing ${{ matrix.service.path }}"
          ls -la "${{ matrix.service.path }}" || true
          echo "Listing workspace root"
          ls -la "${{ github.workspace }}" || true

      - name: Upload Checkov results
        uses: actions/upload-artifact@v4
        with:
          name: checkov-report-${{ matrix.service.name }}
          path: ${{ matrix.service.path }}/checkov-results.sarif

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ matrix.service.path }}/checkov-results.sarif

  deploy-iac:
    name: IaC Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: 
      - terraform-plan-check
      - security-scan
    steps:
      - name: Check out code
        uses: actions/checkout@v5

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4.3.1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: ./.github/actions/setup-terraform
        with:
          terraform-version: ${{ env.TF_VERSION }}
          working-directory: ${{ env.EKS_TF_PATH }}

      - name: Terraform Init (remote S3)
        run: |
          terraform init \
            -backend-config="bucket=${{ env.BUCKET_TF_STATE }}" \
            -backend-config="key=${{ env.EKS_TF_PATH }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -input=false
        working-directory: ${{ env.EKS_TF_PATH }}

      - name: Terraform Apply
        run: terraform apply -auto-approve -input=false -parallelism=1
        working-directory: ${{ env.EKS_TF_PATH }}

